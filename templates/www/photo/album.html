<div id="albumdata" class="hide"
     data-uid="{$userinfo.uid}"
     data-albumid="{$albuminfo.albumid}">
</div>

{literal}
<script language="JavaScript">
    function onphotoload(imgdom) {
        var img = $(imgdom);
        var root = img.closest('.photodiv');
        var coverdiv = root.find('.photocover');
        var deletediv = root.find('.photodelete');
        coverdiv.css('left', imgdom.offsetLeft + 3 + 'px');
        coverdiv.css('top', imgdom.offsetTop + 3 + 'px');
        deletediv.css('left', imgdom.offsetWidth + imgdom.offsetLeft - 20 + 'px');
        deletediv.css('top', imgdom.offsetTop + 3 + 'px');
    }
</script>
{/literal}

<div class="main">
    <div class="title left" style="padding-right: 36px;">
        <img src="{$userinfo.logo80}" style="border-radius: 40px;vertical-align: middle;">
    </div>
    <div class="title left" style="padding-right: 5px;">
        {$userinfo.nickname} 的相册
    </div>
    <div class="title left">
        {if $logininfo.uid == $userinfo.uid && !$albuminfo.isrecycle}
        <span id="txtAlbumtitle">{$albuminfo.title}</span>
        <span id="inputAlbumtitle" class="hide">
            <input type="text" value="{$albuminfo.title}" placeholder="相册标题" style="width: 120px;height: 30px;outline: solid 1px;">
        </span>
        {else}
        {$albuminfo.title}
        {/if}
    </div>
    {if $logininfo.uid == $userinfo.uid && !$albuminfo.isrecycle}
    <div class="title right" style="width:150px;text-align: center;">
        <button id="btnAddPhoto">上传照片</button>
    </div>
    {/if}
    <div class="clear"></div>

    <div style="padding-left: 150px;padding-right: 150px;">
        {if $logininfo.uid == $userinfo.uid && !$albuminfo.isrecycle}
        <span id="txtAlbumintro">{$albuminfo.intro|default:'-'}</span>
        <span id="inputAlbumintro" class="hide"><textarea placeholder="相册说明" style="width: 700px;height: 100px;outline: solid 1px;">{$albuminfo.intro}</textarea></span>
        {else}
        {$albuminfo.intro|default:'-'}
        {/if}
    </div>
    <div class="clear"></div>

    <div class="left">
    {if $page.no > 1}
    <a href="?uid={$userinfo.uid}&albumid={$albuminfo.albumid}&pageno={$page.no-1}">上一页</a>
    {else}
    上一页
    {/if}
    </div>
    <div class="right">
    {if $page.no * $page.num < $page.data_total}
    <a href="?uid={$userinfo.uid}&albumid={$albuminfo.albumid}&pageno={$page.no+1}">下一页</a>
    {else}
    下一页
    {/if}
    </div>
    <div class="clear"></div>

    <div id="photolist">
        {foreach $photolist as $photo}
        <div class="photodiv left" data-photoid="{$photo.photoid}" style="width: 240px;padding: 5px;">
            <div class="photoimgdiv" style="text-align: center;position: relative;">
                {if $logininfo.uid == $userinfo.uid && !$albuminfo.isrecycle}
                <div class="photocover hide" style="position: absolute;top: 0px; left: 0px;line-height: 20px;padding: 3px;">
                    <a href="javascript:;" class="setAlbumCover">C</a>
                </div>
                {/if}
                {if $logininfo.uid == $userinfo.uid}
                <div class="photodelete hide" style="position: absolute;top: 0px; left: 0px;line-height: 20px;padding: 3px;">
                    <a href="javascript:;" class="deletePhoto">X</a>
                </div>
                {/if}
                <a href="item?uid={$photo.uid}&photoid={$photo.photoid}"><img src="{$photo.image}" style="vertical-align: middle;" onload="javascript: onphotoload(this);"></a>
            </div>
            <div class="clear"></div>

            <div style="width: 240px;overflow: hidden;line-height: 30px;height: 30px;white-space: nowrap;text-align: center;">
                {if $logininfo.uid == $userinfo.uid && !$albuminfo.isrecycle}
                <span class="txtPhototitle">{$photo.title}</span>
                <span class="inputPhototitle hide">
	                <input type="text" value="{$photo.title}" placeholder="照片标题" style="text-align: center;width: 240px;height: 30px;outline: solid 1px;">
                </span>
                {else}
                {$photo.title}
                {/if}
            </div>
            <div class="clear"></div>
        </div>
        {/foreach}
        <div class="clear"></div>
    </div>
</div>


{literal}
<script language="JavaScript">
    (function(){
        $('body').delegate('.photoimgdiv', 'mouseenter', function(){
            $(this).find('.photodelete').show();
            $(this).find('.photocover').show();
        });
        $('body').delegate('.photoimgdiv', 'mouseleave', function(){
            $(this).find('.photodelete').hide();
            $(this).find('.photocover').hide();
        });

        function saveTitle() {
            var oldVal = $('#txtAlbumtitle').text();
            var newVal = $('#inputAlbumtitle input').val();
            if (oldVal != newVal && '' != newVal) {
                var uid = $('#albumdata').data('uid');
                var albumid = $('#albumdata').data('albumid');
                $.post('/rest/photo/album/' + uid + '_' + albumid,
                        {'method':'PUT', 'put_style':'title', 'update': newVal},
                        function(data, status){
                            if (data.errno) {
                                alert(data.error);
                            } else {
                                $('#txtAlbumtitle').text(newVal);
                                $('#txtAlbumtitle').show();
                                $('#inputAlbumtitle').hide();
                            }
                        }, 'json');
            } else {
                $('#txtAlbumtitle').show();
                $('#inputAlbumtitle').hide();
            }
        }
        $('body').delegate('#txtAlbumtitle', 'mouseover', function(){
            $('#txtAlbumtitle').hide();
            $('#inputAlbumtitle').show();
            $('#inputAlbumtitle input').focus();
        });
        $('body').delegate('#inputAlbumtitle', 'mouseout', function(){
            saveTitle();
        });
        $('body').delegate('#inputAlbumtitle', 'keydown', function(e){
            if (13 == e.keyCode) {
                saveTitle();
            } else if (27 == e.keyCode) {
                $('#txtAlbumtitle').show();
                $('#inputAlbumtitle').hide();
                $('#inputAlbumtitle input').val($('#txtAlbumtitle').text());
            }
        });

        function saveIntro() {
            var oldVal = $('#txtAlbumintro').text();
            var newVal = $('#inputAlbumintro textarea').val();
            if (oldVal != newVal && '' != newVal && '-' != newVal) {
                var uid = $('#albumdata').data('uid');
                var albumid = $('#albumdata').data('albumid');
                $.post('/rest/photo/album/' + uid + '_' + albumid,
                        {'method':'PUT', 'put_style':'intro', 'update': newVal},
                        function(data, status){
                            if (data.errno) {
                                alert(data.error);
                            } else {
                                $('#txtAlbumintro').text(newVal);
                                $('#txtAlbumintro').show();
                                $('#inputAlbumintro').hide();
                                resetTextareaHeight();
                            }
                        }, 'json');
            } else {
                $('#txtAlbumintro').show();
                $('#inputAlbumintro').hide();
            }
        }
        function resetTextareaHeight() {
            var height = $('#txtAlbumintro').height() - 3;
            if (height > parseInt($('#inputAlbumintro textarea').css('height'))) {
                $('#inputAlbumintro textarea').css('height', height + 'px');
            }
        }
        $('body').delegate('#txtAlbumintro', 'mouseover', function(){
            $('#txtAlbumintro').hide();
            $('#inputAlbumintro').show();
            $('#inputAlbumintro textarea').focus();
        });
        $('body').delegate('#inputAlbumintro', 'mouseout', function(){
            saveIntro();
        });
        $('body').delegate('#inputAlbumintro', 'keydown', function(e){
            if (13 == e.keyCode) {
                saveIntro();
            } else if (27 == e.keyCode) {
                $('#txtAlbumintro').show();
                $('#inputAlbumintro').hide();
                $('#inputAlbumintro textarea').text($('#txtAlbumintro').text());
            }
        });
        $(document).ready(function() {
            resetTextareaHeight();
        });

        function savePhotoTitle(root) {
            var oldVal = root.find('.txtPhototitle').text();
            var newVal = root.find('.inputPhototitle input').val();
            if (oldVal != newVal && '' != newVal) {
                var uid = $('#albumdata').data('uid');
                var photoid = root.data('photoid');
                $.post('/rest/photo/item/' + uid + '_' + photoid,
                        {'method':'PUT', 'put_style':'title', 'update': newVal},
                        function(data, status){
                            if (data.errno) {
                                alert(data.error);
                            } else {
                                root.find('.txtPhototitle').text(newVal);
                                root.find('.txtPhototitle').show();
                                root.find('.inputPhototitle').hide();
                            }
                        }, 'json');
            } else {
                root.find('.txtPhototitle').show();
                root.find('.inputPhototitle').hide();
            }
        }
        $('body').delegate('#photolist .txtPhototitle', 'mouseover', function(){
            var root = $(this).closest('.photodiv');
            root.find('.txtPhototitle').hide();
            root.find('.inputPhototitle').show();
            root.find('.inputPhototitle input').focus();
        });
        $('body').delegate('#photolist .inputPhototitle', 'mouseout', function(){
            var root = $(this).closest('.photodiv');
            savePhotoTitle(root);
        });
        $('body').delegate('#photolist .inputPhototitle', 'keydown', function(e){
            var root = $(this).closest('.photodiv');
            if (13 == e.keyCode) {
                savePhotoTitle(root);
            } else if (27 == e.keyCode) {
                root.find('.txtPhototitle').show();
                root.find('.inputPhototitle').hide();
                root.find('.inputPhototitle input').val(root.find('.txtPhototitle').text());
            }
        });

        $('body').delegate('.setAlbumCover', 'click', function(){
            var uid = $('#albumdata').data('uid');
            var albumid = $('#albumdata').data('albumid');
            var root = $(this).closest('.photodiv');
            var photoid = root.data('photoid');
            if (confirm('确认要设置该照片为相册封面吗？')) {
                $.post('/rest/photo/album/' + uid + '_' + albumid,
                        {'method':'PUT', 'put_style':'cover','update':photoid},
                        function(data, status){
                    if (data.errno) {
                        alert(data.error);
                    } else {
                        alert('设置成功');
                    }
                }, 'json');
            }
        });

        $('body').delegate('.deletePhoto', 'click', function(){
            var uid = $('#albumdata').data('uid');
            var root = $(this).closest('.photodiv');
            var photoid = root.data('photoid');
            if (confirm('确认要删除该照片吗？')) {
                $.post('/rest/photo/item/' + uid + '_' + photoid, {'method':'DELETE'}, function(data, status){
                    if (data.errno) {
                        alert(data.error);
                    } else {
                        root.remove();
                        if (0 == $('#photolist .photodiv').length) {
                            window.location.reload();
                        }
                    }
                }, 'json');
            }
        });

        $(document).ready(function() {
            var albumid = $('#albumdata').data('albumid');
            var uploaderConfig = {
                browse_button: 'btnAddPhoto',
                url: '/rest/photo/item/',
                multi_selection: true,
                multipart_params: {
                    'post_style': 'album',
                    'update': albumid,
                    'after_style': 'default',
                    'after_decorate': 'imageView2/2/w/150/h/150'
                },
                filters: {
                    mime_types: [{'title': '图片文件', 'extensions': 'jpg,gif,png'}],
                    max_file_size: '50mb'
                },
                init: {
                    FilesAdded: function (up, files) {
                        plupload.each(files, function(file) {
                            var photohtml = '<div class="left" id="' + file.id + '" style="width: 240px;height: 290px;padding: 5px;">' +
                                '<div class="photoimage" style="text-align: center;height: 240px;line-height: 240px;">' +
                                '</div>' +
                                '<div class="clear"></div>' +
                                '<div class="phototitle" style="width: 240px;overflow: hidden;line-height: 30px;height: 30px;white-space: nowrap;text-align: center;">' +
                                '等待上传中...</div>' +
                                '<div class="clear"></div>' +
                                '</div>';
                            $('#photolist').html(photohtml + $('#photolist').html());
                            if ('image/gif' == file.type) {
                                var img = new mOxie.FileReader();
                                img.onload = function() {
                                    $('#photolist [id=' + file.id + '] .photoimage').html('<img src="' + img.result + '" width="240px" height="240px">');
                                    img.destroy();
                                    img = null;
                                };
                                img.readAsDataURL(file.getSource());
                            } else {
                                var img = new mOxie.Image();
                                img.onload = function() {
                                    var width = img.width;
                                    var height = img.height;
                                    if (width > 240 || height > 240) {
                                        if (height > width) {
                                            width = width * 240 / height;
                                            height = 240;
                                        } else {
                                            height = height * 240 / width;
                                            width = 240;
                                        }
                                        img.downsize(width, height);
                                    }
                                    $('#photolist [id=' + file.id + '] .photoimage').html('<img src="' + img.getAsDataURL() + '" width="' + width + 'px" height="' + height + 'px">');
                                    img.destroy();
                                    img = null;
                                };
                                img.load(file.getSource());
                            }
                        });
                        up.start();
                    },
                    UploadProgress: function (up, file) {
                        $('#photolist [id=' + file.id + '] .phototitle').html(file.percent + '%');
                    },
                    FileUploaded: function (up, file, info) {
                        eval('var data = ' + info.response);
                        if (data.errno) {
                            alert(data.error);
                        } else {
                            $('#photolist [id=' + file.id + '] .photoimage img').attr('src', data.data.after.image);
                            $('#photolist [id=' + file.id + '] .phototitle').text(data.data.after.title);
                        }
                    },
                    UploadComplete: function (up, files) {
                        var uid = $('#albumdata').data('uid');
                        window.location.href = '?uid=' + uid + '&albumid=' + albumid;
                    },
                    Error: function (up, err) {
                        alert("Error #" + err.code + ": " + err.message + "\n");
                    }
                }
            };
            var btnUploader = new plupload.Uploader(uploaderConfig);
            btnUploader.init();
        });
    })();
</script>
{/literal}
